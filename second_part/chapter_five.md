# 5.Web 服务器
本章主要介绍

- 对不同类型的软硬件 web 服务器进行介绍
- 一步步解释 web 服务器是如何处理 http 事务的

## 各种形状和尺寸的 web 服务器
“web 服务器” 可以用来表示 web 服务器的软件，也可以用来表示提供 web 页面的特定设备或计算机
### web 服务器的实现
web 服务器实现了 http 和相关的 tcp 连接处理，负责管理 web 服务器提供的资源，以及对 web 服务器的配置、控制及扩展方面的管理。
<br><br>
web 服务器逻辑实现了 http 协议、管理着 web 资源，并负责提供 web 服务器的管理功能。web 服务器逻辑和操作系统共同负责管理 TCP 连接。web 服务器有以下不同的形式：
+ 可以在标准的计算机系统上安装并运行的通用软件 web 服务器
+ 如果不行麻烦的安装软件，可以买一台 web 服务器设备，通常安装在计算机上，里面的软件会预装并配置好
+ 计算机芯片上实现的嵌入式 web 服务器


### 实际的 web 服务器会做些什么
  1. 建立一个连接 —— 接受一个客户端连接，如果不希望与整个客户端连接，就将其关闭
  2. 接收请求 —— 从网络中读取一条 http 请求报文
  3. 处理请求 —— 对请求报文进行解释，并采取行动
  4. 访问资源 —— 访问报文中指定的资源
  5. 构建响应 —— 创建带有正确首部的 http 响应报文
  6. 发送响应 —— 将响应回送给客户端
  7. 记录事务处理过程 —— 将与已完成事务有关的内容记录在一个日志文件中
   
```
                                            +------------------------------------------------------+
                                            |                      用户空间                         |
                                            |    +----------------------------------------+        |
                                            |    |             http 服务器软件进程          |        |
                                            |    |                                        |        |
                                            |    |              （3）处理请求               |        |
                                            |    |    +------------------->  ----------+  |        |
                                            |    |    |                                |  |        |
                                            |    |    |  +----+（5）构建响应             |  |        |
                                            |    |    |  |资源 | <--------  资源 <-+    |  |        |
                                            |    |    |  +-|--+ ------------+     |    |  |        |
                                            |    +----∧----|----------------|-----|----|--+        |
                                            | （2）接收请求  |                |     |（4）访问资源     |
                                            +---------|----|----------------|-----|----|-----------+
                                            |         |    |    （7）记录日志 |     |    |           |
                                            |       +-|----|----+           |     |    |           |
                                            |       +-|----|----+           |     |    |           |
                                            |         |    |              +-|-----|----|--------+  | 
                                            |       +-|----|----+         | |     |    |        |  |
                                            | TCP/IP+-|----|----+         | v     |    |        |  |
                                            | 网络协   |    |              |+---+  |    |        |  |
                                            | 议栈   +-|----|-----+        ||日志| |    |        |  |
                                            |       +-|----|----+         |+---+  |    |        |  |
                                            |         |    |              |      +|----|-----+  |  |
                                            |       +-|----|----+         |      |  对象存储  |  |  |
                                            |       +-|----| ----+        |      |  （资源）  |  |  |
                                            |         |    |              |      +-----------+  |  |
                                            |         |    |              |                     |  |
（1）建立连接                                |         |    |              +---------------------+  |
+--------+                                  |    +----|----|--------+                              |
|        | -------------------------------------------+    |        |                              |
| 客户端  |        +----+                    |    |         |        |                              |
|        | <------|资源 |-----------------------------------+        |                              |
+--------+        +----+                    |    |     网络接口      |                              |
              （6）发送响应                   |    +------------------+                              |
                                            |                     操作系统                          |
                                            +------------------------------------------------------+
                                          
                                                    
```

<br><br>
### 第一步 —— 接受客户端连接
如果客户端已经打开了一条到服务器的持久连接，就可以使用那条连接发送它的请求。否则就需要打开一条新的到服务器的连接（[第四章](../first_part/chapter_four.md)）

+ **处理新连接**<br>
1. 客户端请求一条到 web 服务器的 tcp 连接是，web 服务器会建立连接，判断连接的另一端是哪个客户端
   
2. 从 tcp 连接中将 ip 地址解析出来
  
3. 一旦新连接建立起来并接受，服务器就将新连接添加到其现存 web 服务器连接列表中，做好监视连接上数据传输的准备

+ web 服务器可以随意拒绝或立即关闭任意一条连接。
  

<br><br>
+ **客户端主机名识别**<br>
可以用 “反向 DNS” 对大部分 web 服务器进行配置，以便将客户端 ip 地址转换成客户端主机名。主机名查找可能会花费很长时间，会降低 web 事务处理的速度，很多大容量 web 服务器要么禁止主机名解析，要么只允许对特定内容进行解析


<br><br>
+ **通过 ident 确定客户端用户**<br>
有些服务器还支持 IETF 的 ident 协议。服务器可以通过 ident 协议找到发起 http 连接的用户名。
  1. 如果客户端支持 ident 协议，就在 tcp 端口 113 上监听 ident 请求
  2. 客户端打开一条 http 连接
  3. 服务器打开自己到客户端 ident 服务器端口（113）的连接
  4. 然后发起一条简单的请求，询问新连接相对应的用户名
   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ident 在组织内部可以很好的工作，但在因特网上并不能很好的工作，原因包括：
  + 很多客户端 pc 没有运行 ident 识别协议守护进程软件
  + ident 协议会使 http 事务处理产生严重的时延
  + 很多防火墙的限制
  + ident 协议不安全，容易被伪造
  + ident 协议不支持虚拟 ip 地址
  + 暴露客户端用户名还涉及隐私问题
  

<br><br>
### 第二步 —— 接收请求报文
